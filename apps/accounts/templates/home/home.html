{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - Cafeteria Premium{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-gray-100">

    <!-- Main Content com layout mais fluido -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="w-full">

            <!-- Main Grid modernizado -->
            <div class="w-full">
                <div class="bg-white/70 backdrop-blur-md border border-white/20 rounded-3xl shadow-xl overflow-hidden">
                    
                    <!-- Header com tabs modernos e campo de pesquisa -->
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                                <div class="w-8 h-8 bg-gradient-to-r from-orange-500 to-pink-500 rounded-lg flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                Comandas do Balc√£o
                            </h2>
                            
                            <div class="flex items-center space-x-1 bg-gray-100 rounded-2xl p-1">
                                <!-- Bot√£o Nova Comanda -->
                                <button onclick="openOrderModal()" class="flex items-center space-x-2 bg-gradient-to-r from-orange-500 to-pink-500 text-white px-6 py-3 rounded-2xl font-semibold hover:from-orange-600 hover:to-pink-600 transition-all duration-300 transform hover:scale-105 hover:shadow-lg shadow-md">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    <span>Nova Comanda</span>
                                </button>
                            </div>
                        </div>

                        <!-- Campo de Pesquisa Moderno -->
                        <div class="relative max-w-md">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <input 
                                type="text" 
                                id="search-comandas"
                                class="w-full pl-12 pr-12 py-3 bg-white/70 backdrop-blur-md border border-white/20 rounded-2xl text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500/50 focus:border-orange-300 transition-all duration-300 shadow-sm hover:shadow-md" 
                                placeholder="Pesquisar por n√∫mero da comanda, mesa ou cliente..."
                                autocomplete="off"
                            >
                            
                            <!-- Bot√£o de limpar pesquisa -->
                            <button 
                                type="button"
                                id="clear-search"
                                class="absolute inset-y-0 right-0 pr-4 flex items-center opacity-0 transition-opacity duration-200 hover:text-gray-700"
                            >
                                <svg class="w-5 h-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            
                            <!-- Contador de resultados -->
                            <div id="search-results" class="absolute top-full left-0 right-0 mt-2 text-sm text-gray-500 opacity-0 transition-opacity duration-200">
                                <span id="results-count">0</span> comandas encontradas
                            </div>
                        </div>
                    </div>

                    <!-- Grid de comandas com visual moderno -->
                    <div class="p-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-4 gap-6">
                            
                            {% for comanda in comandas_abertas %}
                                <!-- Comanda real com estilo simplificado -->
                                <div onclick="openEditOrderModal('{{ comanda.code }}')" 
                                    style="height: 160px !important;"
                                    class="group relative bg-white border-2 cursor-pointer
                                    {% if comanda.status == 'aguardando' %}border-orange-100 hover:border-orange-300{% endif %}
                                    {% if comanda.status == 'preparando' %}border-yellow-100 hover:border-yellow-300{% endif %}
                                    {% if comanda.status == 'pronta' %}border-green-100 hover:border-green-300{% endif %}
                                    rounded-2xl p-3 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 "
                                    data-comanda 
                                    data-numero="{{ comanda.code }}" 
                                    data-mesa="{{ comanda.name }}">
                                
                                    <!-- Header da comanda -->
                                    <div class="flex items-center space-x-3 mb-2">
                                        <div class="w-12 h-12 
                                                    {% if comanda.status == 'aguardando' %}bg-gradient-to-r from-orange-500 to-pink-500{% endif %}
                                                    {% if comanda.status == 'preparando' %}bg-gradient-to-r from-yellow-500 to-orange-500{% endif %}
                                                    {% if comanda.status == 'pronta' %}bg-gradient-to-r from-emerald-500 to-teal-500{% endif %}
                                                    rounded-2xl flex items-center justify-center text-white font-bold">
                                            #{{ comanda.id }}
                                        </div>
                                        <div>
                                            <p class="font-semibold text-gray-900">{{ comanda.name }}</p>
                                            <p class="text-xs text-gray-500">
                                                {{ comanda.created_at|time:"H:i" }} ‚Ä¢ 
                                                {% if comanda.status == 'aguardando' %}Aguardando
                                                {% elif comanda.status == 'preparando' %}Em preparo
                                                {% elif comanda.status == 'pronta' %}Pronta
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Valor centralizado -->
                                    <div class="border-t border-gray-100 pt-2 mb-2">
                                        <div class="text-center">
                                            <span class="text-lg font-bold text-gray-900">R$ {{ comanda.total_amount }}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Bot√£o Detalhes -->
                                    <button onclick="event.stopPropagation(); openEditOrderModal('{{ comanda.code }}')" 
                                            class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white py-2 px-4 rounded-xl text-sm font-semibold hover:from-emerald-600 hover:to-teal-600 transition-all transform hover:scale-105">
                                        Detalhes
                                    </button>
                                </div>
                            {% empty %}
                                <!-- Quando n√£o h√° comandas -->
                                <div class="col-span-full text-center py-12">
                                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h3 class="text-lg font-medium text-gray-900 mb-2">Nenhuma comanda aberta</h3>
                                    <p class="text-gray-500">Todas as comandas foram finalizadas ou n√£o h√° comandas criadas.</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% include 'home/order_modal.html' %}
{% include 'home/detail_modal.html' %}
{% include 'home/payment_modal.html' %}

<script src="{% static 'js/utils.js' %}"></script>

<script>
function openOrderModal() {
    const modal = document.getElementById('orderModal');
    if (modal) {
        // Remover classes que escondem
        modal.classList.remove('hidden', 'opacity-0');
        
        // For√ßar propriedades do overlay
        modal.style.cssText = `
            display: flex !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 9999 !important;
            background-color: rgba(0, 0, 0, 0.5) !important;
            opacity: 1 !important;
            visibility: visible !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 16px !important;
        `;
        
        document.body.style.overflow = 'hidden';
        
        // Inicializar funcionalidades do modal
        initializeOrderModal();
        
        // Focar no campo de nome da comanda ap√≥s o modal ser exibido
        setTimeout(() => {
            const orderNameField = document.getElementById('orderName');
            if (orderNameField) {
                orderNameField.focus();
            }
        }, 100);
        
        console.log('Modal centralizado!');
    }
}
function closeOrderModal() {
    const modal = document.getElementById('orderModal');
    if (modal) {
        // Adicionar classes para esconder
        modal.classList.add('hidden', 'opacity-0');
        
        // Resetar o estilo
        modal.style.display = 'none';
        
        // Restaurar scroll do body
        document.body.style.overflow = '';
        
        // Limpar o formul√°rio
        const form = document.getElementById('orderForm');
        if (form) {
            form.reset();
        }
        
        console.log('Modal fechado!');
    }
}
</script>

<script>

// Sistema de Polling Inteligente para comandas
class OrderPolling {
    constructor() {
        this.lastKnownState = {
            comandas_abertas: 0,
            total_comandas_hoje: 0,
            ultima_atualizacao: null
        };
        this.pollingInterval = null;
        this.isPolling = false;
        this.isPaused = false;
        this.pendingChanges = false;
        
        // Inicializar com estado atual da p√°gina
        this.initializeCurrentState();
        
        // Come√ßar polling ap√≥s 10 segundos
        setTimeout(() => {
            this.startPolling();
        }, 10000);
        
        // Monitorar abertura/fechamento de modais
        this.setupModalWatchers();
    }
    
    setupModalWatchers() {
        // Observador para detectar quando modais s√£o abertos/fechados
        const observer = new MutationObserver((mutations) => {
            this.checkModalStatus();
        });
        
        // Observar mudan√ßas no DOM para detectar modais
        observer.observe(document.body, {
            attributes: true,
            childList: true,
            subtree: true,
            attributeFilter: ['style', 'class']
        });
        
        // Verifica√ß√£o inicial
        this.checkModalStatus();
        
        // Verificar a cada 2 segundos tamb√©m (backup)
        setInterval(() => {
            this.checkModalStatus();
        }, 2000);
    }
    
    checkModalStatus() {
        // Verificar se algum modal est√° vis√≠vel
        const modals = [
            document.getElementById('orderModal'),
            document.getElementById('editOrderModal'),
            document.querySelector('[id*="modal"]'),
        ];
        
        let modalAberto = false;
        
        modals.forEach(modal => {
            if (modal) {
                const isVisible = modal.style.display !== 'none' && 
                                modal.style.display !== '' && 
                                !modal.classList.contains('hidden');
                if (isVisible) modalAberto = true;
            }
        });
        
        // Verificar se h√° overlay de modal
        const overlays = document.querySelectorAll('.fixed.inset-0, [class*="modal"], [class*="overlay"]');
        overlays.forEach(overlay => {
            if (overlay.style.display !== 'none' && !overlay.classList.contains('hidden')) {
                modalAberto = true;
            }
        });
        
        // Pausar/retomar polling baseado no status do modal
        if (modalAberto && !this.isPaused) {
            this.pausePolling();
        } else if (!modalAberto && this.isPaused) {
            this.resumePolling();
        }
    }
    
    pausePolling() {
        this.isPaused = true;
        console.log('‚è∏Ô∏è Polling pausado - Modal detectado aberto');
        this.showPollingStatus('paused');
    }
    
    resumePolling() {
        this.isPaused = false;
        console.log('‚ñ∂Ô∏è Polling retomado - Modal fechado');
        this.showPollingStatus('active');
        
        // Se h√° mudan√ßas pendentes, verificar imediatamente
        if (this.pendingChanges) {
            console.log('üîÑ Verificando mudan√ßas pendentes...');
            this.checkForChanges();
            this.pendingChanges = false;
        }
    }
    
    showPollingStatus(status) {
        // Mostrar indicador visual discreto (opcional)
        let indicator = document.getElementById('polling-indicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'polling-indicator';
            indicator.className = 'fixed bottom-4 left-4 z-50 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg shadow-lg transition-all duration-300';
            document.body.appendChild(indicator);
        }
        
        if (status === 'paused') {
            indicator.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                    <span>Sincroniza√ß√£o pausada</span>
                </div>
            `;
            indicator.style.opacity = '1';
        } else if (status === 'active') {
            indicator.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <span>Sincronizando...</span>
                </div>
            `;
            indicator.style.opacity = '0.7';
            
            // Esconder ap√≥s 3 segundos
            setTimeout(() => {
                indicator.style.opacity = '0';
            }, 3000);
        }
    }
    
    initializeCurrentState() {
        // Pegar estado atual das comandas na p√°gina
        const comandaCards = document.querySelectorAll('[data-comanda]');
        this.lastKnownState.comandas_abertas = comandaCards.length;
        
        console.log('üîÑ Estado inicial das comandas:', this.lastKnownState.comandas_abertas);
    }
    
    async checkForChanges() {
        if (this.isPolling) return; // Evitar m√∫ltiplas chamadas simult√¢neas
        if (this.isPaused) {
            console.log('‚è∏Ô∏è Polling pausado - verifica√ß√£o adiada');
            this.pendingChanges = true;
            return;
        }
        
        this.isPolling = true;
        
        try {
            const response = await fetch('/accounts/api/check-orders-changes/');
            const data = await response.json();
            
            if (data.success) {
                const hasChanges = this.detectChanges(data);
                
                if (hasChanges) {
                    console.log('üîÑ Mudan√ßas detectadas! Recarregando p√°gina...');
                    
                    // Salvar notifica√ß√£o se necess√°rio
                    if (data.comandas_abertas > this.lastKnownState.comandas_abertas) {
                        localStorage.setItem('comandaNotificacao', JSON.stringify({
                            message: 'NOVA COMANDA CRIADA! P√°gina atualizada automaticamente.',
                            type: 'sucesso'
                        }));
                    }
                    
                    window.location.reload();
                } else {
                    console.log('‚úÖ Nenhuma mudan√ßa detectada');
                }
                
                // Atualizar estado conhecido
                this.lastKnownState = {
                    comandas_abertas: data.comandas_abertas,
                    total_comandas_hoje: data.total_comandas_hoje,
                    ultima_atualizacao: data.ultima_atualizacao
                };
            }
            
        } catch (error) {
            console.error('‚ùå Erro ao verificar mudan√ßas:', error);
        } finally {
            this.isPolling = false;
        }
    }
    
    detectChanges(newData) {
        // Verificar se h√° novas comandas ou mudan√ßas
        const mudancas = {
            novasComandas: newData.comandas_abertas !== this.lastKnownState.comandas_abertas,
            totalMudou: newData.total_comandas_hoje !== this.lastKnownState.total_comandas_hoje,
            atualizacaoMudou: newData.ultima_atualizacao !== this.lastKnownState.ultima_atualizacao
        };
        
        const hasChanges = mudancas.novasComandas || mudancas.totalMudou || mudancas.atualizacaoMudou;
        
        if (hasChanges) {
            console.log('üìä Mudan√ßas detectadas:', {
                'Comandas abertas': `${this.lastKnownState.comandas_abertas} ‚Üí ${newData.comandas_abertas}`,
                'Total hoje': `${this.lastKnownState.total_comandas_hoje} ‚Üí ${newData.total_comandas_hoje}`,
                '√öltima atualiza√ß√£o mudou': mudancas.atualizacaoMudou
            });
        }
        
        return hasChanges;
    }
    
    startPolling() {
        console.log('üöÄ Iniciando monitoramento autom√°tico de comandas (15s)');
        
        this.pollingInterval = setInterval(() => {
            this.checkForChanges();
        }, 15000); // 15 segundos
        
        // Verifica√ß√£o inicial
        this.checkForChanges();
    }
    
    stopPolling() {
        if (this.pollingInterval) {
            clearInterval(this.pollingInterval);
            this.pollingInterval = null;
            console.log('‚èπÔ∏è Monitoramento autom√°tico parado');
        }
    }
}

// Focar automaticamente no campo de pesquisa quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-comandas');
    if (searchInput) {
        // Dar foco no campo
        searchInput.focus();
        
        // Posicionar cursor no final do texto (caso tenha algum valor)
        searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
        
        console.log('Foco autom√°tico aplicado no campo de pesquisa');
    }
});

// Tamb√©m focar quando a p√°gina ficar vis√≠vel novamente (quando voltar de outra aba/aplicativo)
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        const searchInput = document.getElementById('search-comandas');
        if (searchInput) {
            // Pequeno delay para garantir que a p√°gina est√° totalmente carregada
            setTimeout(() => {
                searchInput.focus();
            }, 100);
        }
    }
});

// Focar novamente quando clicar em qualquer lugar da p√°gina (√∫til para leitores de c√≥digo)
document.addEventListener('click', function(e) {
    // N√£o focar se clicou em um input, button ou link
    if (!e.target.matches('input, button, a, select, textarea')) {
        const searchInput = document.getElementById('search-comandas');
        if (searchInput) {
            searchInput.focus();
        }
    }
});
</script>

<!-- DEPOIS vem o JS externo -->
<script src="{% static 'js/home/home.js' %}"></script>

<script>
// Fun√ß√£o para mostrar notifica√ß√£o (padr√£o dos produtos)
function mostrarNotificacao(mensagem, tipo = 'success') {
    // Criar o container se n√£o existir
    let container = document.getElementById('notifications-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'fixed top-20 right-4 z-40 space-y-3';
        container.id = 'notifications-container';
        document.body.appendChild(container);
    }

    // Criar elemento da notifica√ß√£o seguindo EXATAMENTE o padr√£o dos produtos
    const notification = document.createElement('div');
    notification.className = `notification-toast transform translate-x-full opacity-0 bg-green-100/10 border border-green-100/10 text-green-800 backdrop-blur-xl backdrop-saturate-150 px-4 py-3 rounded-2xl shadow-2xl min-w-[320px] max-w-md`;
    notification.setAttribute('data-notification', '');
    
    notification.innerHTML = `
        <div class="flex items-center space-x-3">
            <!-- √çcone -->
            <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
            
            <!-- Mensagem -->
            <div class="flex-1 text-sm font-semibold">
                ${mensagem}
            </div>
            
            <!-- Bot√£o fechar -->
            <button onclick="closeNotification(this)" 
                    class="flex-shrink-0 text-green-600/70 hover:text-green-700 hover:bg-green-500/20 transition-all duration-200 rounded-full p-1.5">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
        
        <!-- Barra de progresso -->
        <div class="absolute bottom-0 left-0 h-1 bg-green-200/50 rounded-bl-2xl rounded-br-2xl">
            <div class="h-full bg-green-500 rounded-bl-2xl rounded-br-2xl progress-bar" style="width: 100%;"></div>
        </div>
    `;
    
    // Adicionar √† container
    container.appendChild(notification);
    
    // Animar entrada
    setTimeout(() => {
        notification.classList.remove('translate-x-full', 'opacity-0');
    }, 100);
    
    // Remover ap√≥s 5 segundos
    setTimeout(() => {
        if (notification && notification.parentElement) {
            notification.classList.add('hiding');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 300);
        }
    }, 5000);
}

// Fun√ß√£o para fechar notifica√ß√£o (necess√°ria para o bot√£o X)
function closeNotification(button) {
    const notification = button.closest('[data-notification]');
    notification.classList.add('hiding');
    setTimeout(() => {
        notification.remove();
    }, 300);
}

// Verificar se h√° notifica√ß√£o pendente no localStorage
document.addEventListener('DOMContentLoaded', function() {
    const notificacaoPendente = localStorage.getItem('comandaNotificacao');
    if (notificacaoPendente) {
        try {
            const notif = JSON.parse(notificacaoPendente);
            // Mostrar notifica√ß√£o ap√≥s um pequeno delay
            setTimeout(() => {
                mostrarNotificacao(notif.message, notif.type);
            }, 500);
            
            // Limpar do localStorage
            localStorage.removeItem('comandaNotificacao');
        } catch (e) {
            console.error('Erro ao processar notifica√ß√£o:', e);
            localStorage.removeItem('comandaNotificacao');
        }
    }
});
</script>

<!-- Estilos CSS que acompanham o padr√£o dos produtos -->
<style>
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

@keyframes progressBar {
    from {
        width: 100%;
    }
    to {
        width: 0%;
    }
}

.notification-toast {
    animation: slideInRight 0.4s ease-out forwards;
}

.notification-toast.hiding {
    animation: slideOutRight 0.3s ease-in forwards;
}

.progress-bar {
    animation: progressBar 5s linear forwards;
}
</style>

{% endblock %}